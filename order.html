<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - POS System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Raleway:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/order.css">
</head>

<body>
    <div class="main-wrapper">
        <div class="container">
            <!-- Branded Header -->
            <div class="branded-header">
                <div class="brand-logo">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="brand-info">
                    <h1>PRISTINE DINING</h1>
                    <p>Order Management System</p>
                </div>
            </div>

            <div class="header-section">
                <div class="title-group">
                    <h2><i class="fas fa-receipt"></i> Orders</h2>
                    <p class="subtitle">Manage and track all customer orders</p>
                </div>
                <div class="stats-group">
                    <div class="stat-card">
                        <span class="stat-number" id="total-orders">0</span>
                        <span class="stat-label">Total Orders</span>
                    </div>
                    <div class="stat-card pending-stat">
                        <span class="stat-number" id="pending-orders">0</span>
                        <span class="stat-label">Pending</span>
                    </div>
                    <div class="stat-card completed-stat">
                        <span class="stat-number" id="completed-orders-count">0</span>
                        <span class="stat-label">Done</span>
                        <i class="fas fa-eye stat-toggle-icon"></i>
                    </div>
                </div>
            </div>

            <div class="search-bar">
                <i class="fas fa-calendar"></i>
                <input type="date" id="date-picker">
                <button class="refresh-btn" onclick="refreshOrders()" title="Refresh orders">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <div class="main-layout">
                <!-- Pending Orders Section -->
                <div class="orders-section">
                    <div class="section-header">
                        <h2><i class="fas fa-hourglass-half"></i> Pending Orders</h2>
                        <span class="badge-count" id="pending-badge">0</span>
                    </div>
                    <div id="pending-orders-container" class="cards-grid">
                        <!-- Pending orders will be displayed as cards here -->
                    </div>
                </div>

                <!-- Completed Orders Section (Hidden by default) -->
                <div class="orders-section" id="completed-orders-section" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-check-circle"></i> Done Orders</h2>
                        <span class="badge-count completed-badge" id="completed-badge">0</span>
                    </div>
                    <div id="completed-orders-container" class="cards-grid">
                        <!-- Completed orders will be displayed as cards here -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Fixed Navigation Popup -->
    <div class="nav-popup-overlay" id="navOverlay"></div>
    <div class="nav-popup" id="navPopup">
        <button class="nav-popup-close" onclick="closeNavPopup()">
            <i class="fas fa-times"></i>
        </button>
        <h3>Test Pages</h3>
        <nav class="nav-popup-list">
            <a href="login.html" class="nav-popup-link">
                <i class="fas fa-sign-in-alt"></i> Login
            </a>
            <a href="register.html" class="nav-popup-link">
                <i class="fas fa-user-plus"></i> Register
            </a>
            <a href="order.html" class="nav-popup-link active">
                <i class="fas fa-receipt"></i> Orders
            </a>
            <a href="reservation.html" class="nav-popup-link">
                <i class="fas fa-calendar-alt"></i> Reservations
            </a>
            <a href="restaurant_bill.html" class="nav-popup-link">
                <i class="fas fa-file-invoice"></i> Bill
            </a>
            <a href="restaurant_reception.html" class="nav-popup-link">
                <i class="fas fa-door-open"></i> Reception
            </a>
        </nav>
    </div>

    <!-- Note Editor Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-sticky-note"></i> Edit Order Note</h2>
                <button class="modal-close-btn" onclick="closeNoteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="modal-textarea" id="noteInput" placeholder="Add notes for this order..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeNoteModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="modal-btn modal-btn-primary" onclick="saveNote()">
                    <i class="fas fa-save"></i> Save Note
                </button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-print"></i> Order Details</h2>
                <button class="modal-close-btn" onclick="closePrintModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-print-content" id="printContent"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closePrintModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="modal-btn modal-btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <button class="nav-popup-btn" onclick="toggleNavPopup()">
        <i class="fas fa-bars"></i>
    </button>

    <script>
        // Navigation Popup Functions
        function toggleNavPopup() {
            const popup = document.getElementById('navPopup');
            const overlay = document.getElementById('navOverlay');
            popup.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeNavPopup() {
            const popup = document.getElementById('navPopup');
            const overlay = document.getElementById('navOverlay');
            popup.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Close popup when clicking overlay
        document.getElementById('navOverlay').addEventListener('click', closeNavPopup);

        // Close popup when pressing Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeNavPopup();
        });

        // Orders Management Functions
        const totalOrdersSpan = document.getElementById('total-orders');
        const pendingOrdersSpan = document.getElementById('pending-orders');
        const completedOrdersCountSpan = document.getElementById('completed-orders-count');
        const pendingOrdersContainer = document.getElementById('pending-orders-container');
        const completedOrdersContainer = document.getElementById('completed-orders-container');
        const pendingBadge = document.getElementById('pending-badge');
        const completedBadge = document.getElementById('completed-badge');
        const completedOrdersSection = document.getElementById('completed-orders-section');
        const completedStatCard = document.querySelector('.completed-stat');

        let orders = [
            { id: '#1001', customer: 'John Doe', items: 'Pizza, Coke', price: '$25.50', status: 'Pending', date: '2025-11-14', time: '2:30 PM', note: '' },
            { id: '#1002', customer: 'Jane Smith', items: 'Burger, Fries', price: '$15.00', status: 'Pending', date: '2025-11-14', time: '2:45 PM', note: '' },
            { id: '#1003', customer: 'Alice Wonderland', items: 'Salad, Iced Tea', price: '$12.75', status: 'Pending', date: '2025-11-14', time: '2:50 PM', note: '' },
            { id: '#1004', customer: 'Bob Johnson', items: 'Fish & Chips', price: '$18.90', status: 'Pending', date: '2025-11-14', time: '3:05 PM', note: '' },
            { id: '#1005', customer: 'Emily Chen', items: 'Pasta, Wine', price: '$32.50', status: 'Pending', date: '2025-11-14', time: '3:15 PM', note: '' },
            { id: '#1006', customer: 'Michael Brown', items: 'Steak, Potatoes', price: '$45.00', status: 'Pending', date: '2025-11-14', time: '3:20 PM', note: '' },
            { id: '#1007', customer: 'Sarah Davis', items: 'Sushi, Green Tea', price: '$28.75', status: 'Pending', date: '2025-11-14', time: '3:25 PM', note: '' },
            { id: '#1008', customer: 'David Wilson', items: 'Chicken Sandwich', price: '$14.50', status: 'Pending', date: '2025-11-14', time: '3:30 PM', note: '' },
        ];
        let completedOrders = [];
        let filteredOrders = [...orders];

        // Refresh function
        function refreshOrders() {
            filterByDate();
        }

        function updateOrderCounts() {
            const pendingCount = orders.filter(o => o.status === 'Pending').length;
            const doneCount = completedOrders.length;
            const total = pendingCount + doneCount;

            totalOrdersSpan.textContent = total;
            pendingOrdersSpan.textContent = pendingCount;
            completedOrdersCountSpan.textContent = doneCount;
            pendingBadge.textContent = pendingCount;
            completedBadge.textContent = doneCount;
        }

        function renderOrders(ordersToRender = null) {
            const displayOrders = ordersToRender || orders;
            pendingOrdersContainer.innerHTML = '';

            displayOrders.filter(o => o.status === 'Pending').forEach((order, index) => {
                const originalIndex = orders.findIndex(o => o.id === order.id);
                const card = document.createElement('div');
                card.classList.add('order-card');
                card.setAttribute('data-index', originalIndex);
                card.innerHTML = `
                    <div class="card-header">
                        <span class="order-id">${order.id}</span>
                        <span class="order-time"><i class="fas fa-clock"></i> ${order.time}</span>
                    </div>
                    <div class="card-body">
                        <h3 class="customer-name">${order.customer}</h3>
                        <p class="order-items">${order.items}</p>
                        <div class="card-note-section">
                            <label>Note:</label>
                            <div class="note-display" data-index="${originalIndex}">${order.note || 'No notes'}</div>
                        </div>
                        <div class="card-footer">
                            <span class="order-price">${order.price}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn print-btn" onclick="printOrder(${originalIndex})" title="Print order">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="action-btn done-btn" onclick="completeOrder(${originalIndex})" title="Mark as done">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteOrder(${originalIndex})" title="Delete order">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn note-btn" onclick="editNote(${originalIndex})" title="Add/Edit note">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                    </div>
                `;
                pendingOrdersContainer.appendChild(card);
            });

            // If no pending orders, show empty state
            if (displayOrders.filter(o => o.status === 'Pending').length === 0) {
                pendingOrdersContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i> <p>No pending orders</p></div>';
            }
        }

        function renderCompletedOrders(ordersToRender = null) {
            const displayOrders = ordersToRender || completedOrders;
            completedOrdersContainer.innerHTML = '';

            displayOrders.filter(o => o.status === 'Done').forEach((order, index) => {
                const card = document.createElement('div');
                card.classList.add('order-card', 'completed');
                card.innerHTML = `
                    <div class="card-header">
                        <span class="order-id">${order.id}</span>
                        <span class="status-badge"><i class="fas fa-check-circle"></i> Done</span>
                    </div>
                    <div class="card-body">
                        <h3 class="customer-name">${order.customer}</h3>
                        <p class="order-items">${order.items}</p>
                        <div class="card-note-section">
                            <label>Note:</label>
                            <div class="note-display">${order.note || 'No notes'}</div>
                        </div>
                        <div class="card-footer">
                            <span class="order-price">${order.price}</span>
                        </div>
                    </div>
                `;
                completedOrdersContainer.appendChild(card);
            });

            // If no completed orders, show empty state
            if (displayOrders.filter(o => o.status === 'Done').length === 0) {
                completedOrdersContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i> <p>No done orders</p></div>';
            }
        }

        function completeOrder(index) {
            const order = orders[index];
            order.status = 'Done';
            completedOrders.push({ ...order });
            orders.splice(index, 1);
            sessionStorage.setItem('completedOrders', JSON.stringify(completedOrders));
            updateOrderCounts();
            renderOrders(filteredOrders);
            renderCompletedOrders();
        }

        function deleteOrder(index) {
            if (confirm('Are you sure you want to delete this order?')) {
                orders.splice(index, 1);
                updateOrderCounts();
                renderOrders(filteredOrders);
            }
        }

        function printOrder(index) {
            const order = orders[index];
            const printContent = `
                <p><strong>Order ID:</strong> ${order.id}</p>
                <p><strong>Customer:</strong> ${order.customer}</p>
                <p><strong>Items:</strong> ${order.items}</p>
                <p><strong>Price:</strong> ${order.price}</p>
                <p><strong>Time:</strong> ${order.time}</p>
                <p><strong>Note:</strong> ${order.note || 'No notes'}</p>
            `;
            document.getElementById('printContent').innerHTML = printContent;
            document.getElementById('printModal').classList.add('active');
        }

        function closePrintModal() {
            document.getElementById('printModal').classList.remove('active');
        }

        let currentNoteIndex = null;

        function editNote(index) {
            currentNoteIndex = index;
            document.getElementById('noteInput').value = orders[index].note || '';
            document.getElementById('noteModal').classList.add('active');
            document.getElementById('noteInput').focus();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            currentNoteIndex = null;
        }

        function saveNote() {
            if (currentNoteIndex !== null) {
                orders[currentNoteIndex].note = document.getElementById('noteInput').value;
                renderOrders(filteredOrders);
                closeNoteModal();
            }
        }

        // Modal keyboard handlers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeNoteModal();
                closePrintModal();
            }
        });

        // Date filtering function
        function filterByDate() {
            const datePickerValue = document.getElementById('date-picker').value;

            if (!datePickerValue) {
                // If no date selected, show all orders
                filteredOrders = [...orders];
            } else {
                // Filter orders by selected date
                filteredOrders = orders.filter(order => order.date === datePickerValue);
            }

            updateOrderCounts();
            renderOrders(filteredOrders);
        }

        // Add event listener for date picker
        document.getElementById('date-picker').addEventListener('change', filterByDate);

        // Toggle completed orders section when clicking the completed stat card
        const mainLayout = document.querySelector('.main-layout');
        const cardsGrids = document.querySelectorAll('.cards-grid');

        // Function to update layout based on window size and visibility state
        function updateLayout() {
            const isCompleted = completedOrdersSection.style.display !== 'none';
            const windowWidth = window.innerWidth;
            const cardsGrids = document.querySelectorAll('.cards-grid'); // Move here for dynamic selection

            console.log('=== updateLayout DEBUG ===');
            console.log('isCompleted:', isCompleted);
            console.log('windowWidth:', windowWidth);
            console.log('cardsGrids count:', cardsGrids.length);
            console.log('cardsGrids:', cardsGrids);

            if (isCompleted) {
                console.log('Mode: BOTH LISTS (Pending + Completed)');
                // Showing both Pending and Completed
                if (windowWidth < 768) {
                    // Mobile: stack vertically, 1 card per row
                    console.log('→ <768px: mainLayout=1fr, cards=1fr');
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        console.log(`Grid ${idx} before:`, grid.style.gridTemplateColumns);
                        grid.style.setProperty('grid-template-columns', '1fr', 'important');
                        console.log(`Grid ${idx} after:`, grid.style.gridTemplateColumns);
                    });
                } else if (windowWidth < 1400) {
                    // Tablet: 2 columns, 1 card per row each
                    console.log('→ 768-1400px: mainLayout=1fr 1fr, cards=1fr');
                    mainLayout.style.gridTemplateColumns = '1fr 1fr';
                    cardsGrids.forEach((grid, idx) => {
                        console.log(`Grid ${idx} before:`, grid.style.gridTemplateColumns);
                        grid.style.setProperty('grid-template-columns', '1fr', 'important');
                        console.log(`Grid ${idx} after:`, grid.style.gridTemplateColumns);
                    });
                } else {
                    // Desktop: 2 columns, 2 cards per row each
                    console.log('→ >1400px: mainLayout=1fr 1fr, cards=repeat(2,1fr)');
                    mainLayout.style.gridTemplateColumns = '1fr 1fr';
                    cardsGrids.forEach((grid, idx) => {
                        console.log(`Grid ${idx} before:`, grid.style.gridTemplateColumns);
                        grid.style.setProperty('grid-template-columns', 'repeat(2, 1fr)', 'important');
                        console.log(`Grid ${idx} after:`, grid.style.gridTemplateColumns);
                    });
                }
            } else {
                console.log('Mode: SINGLE LIST (Pending only)');
                // Showing only Pending
                if (windowWidth < 480) {
                    // Mobile: 1 card per row
                    console.log('→ <480px: mainLayout=1fr, cards=1fr');
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        console.log(`Grid ${idx} before:`, grid.style.gridTemplateColumns);
                        grid.style.setProperty('grid-template-columns', '1fr', 'important');
                        console.log(`Grid ${idx} after:`, grid.style.gridTemplateColumns);
                    });
                } else if (windowWidth < 768) {
                    // Tablet: 2 cards per row
                    console.log('→ 480-768px: mainLayout=1fr, cards=repeat(2,1fr)');
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        console.log(`Grid ${idx} before:`, grid.style.gridTemplateColumns);
                        grid.style.setProperty('grid-template-columns', 'repeat(2, 1fr)', 'important');
                        console.log(`Grid ${idx} after:`, grid.style.gridTemplateColumns);
                    });
                } else if (windowWidth < 1400) {
                    // Tablet+: 3 cards per row
                    console.log('→ 768-1400px: mainLayout=1fr, cards=repeat(3,1fr)');
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        console.log(`Grid ${idx} before:`, grid.style.gridTemplateColumns);
                        grid.style.setProperty('grid-template-columns', 'repeat(3, 1fr)', 'important');
                        console.log(`Grid ${idx} after:`, grid.style.gridTemplateColumns);
                    });
                } else {
                    // Desktop: 4 cards per row
                    console.log('→ >1400px: mainLayout=1fr, cards=repeat(4,1fr)');
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        console.log(`Grid ${idx} before:`, grid.style.gridTemplateColumns);
                        grid.style.setProperty('grid-template-columns', 'repeat(4, 1fr)', 'important');
                        console.log(`Grid ${idx} after:`, grid.style.gridTemplateColumns);
                    });
                }
            }
            console.log('=== END DEBUG ===\n');
        }

        // Initial layout
        updateLayout();

        // Toggle on completed stat card click
        completedStatCard.addEventListener('click', () => {
            const isHidden = completedOrdersSection.style.display === 'none';
            completedOrdersSection.style.display = isHidden ? 'block' : 'none';
            completedStatCard.classList.toggle('active');
            const icon = completedStatCard.querySelector('.stat-toggle-icon');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
            updateLayout();
        });

        // Update layout on window resize
        window.addEventListener('resize', updateLayout);

        // Load completed orders from session storage
        const lastResetDate = sessionStorage.getItem('lastResetDate');
        const today = new Date().toDateString();

        if (lastResetDate !== today) {
            sessionStorage.setItem('completedOrders', JSON.stringify([]));
            sessionStorage.setItem('lastResetDate', today);
        } else {
            const storedCompletedOrders = sessionStorage.getItem('completedOrders');
            if (storedCompletedOrders) {
                completedOrders = JSON.parse(storedCompletedOrders);
            }
        }

        // Set date picker to today by default
        const todayISO = new Date().toISOString().split('T')[0];
        document.getElementById('date-picker').value = todayISO;
        filterByDate();

        // Initial render
        updateOrderCounts();
        renderOrders();
        renderCompletedOrders();
    </script>
</body>

</html>