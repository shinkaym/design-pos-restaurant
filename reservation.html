<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Management - POS System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Raleway:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/reservation.css">
    <script src="shared.js" defer></script>
</head>

<body>
    <div class="main-wrapper">
        <div class="container">
            <!-- Branded Header -->
            <div class="branded-header">
                <div class="brand-logo">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="brand-info">
                    <h1>PRISTINE DINING</h1>
                    <p>Reservation Management System</p>
                </div>
            </div>

            <div class="header-section">
                <div class="title-group">
                    <h2><i class="fas fa-calendar-alt"></i> Reservations</h2>
                    <p class="subtitle">Manage and track all guest reservations</p>
                </div>
                <div class="stats-group">
                    <div class="stat-card">
                        <span class="stat-number" id="total-reservations">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-card pending-stat">
                        <span class="stat-number" id="pending-reservations">0</span>
                        <span class="stat-label">Pending</span>
                    </div>
                    <div class="stat-card completed-stat">
                        <span class="stat-number" id="completed-reservations-count">0</span>
                        <span class="stat-label">Done</span>
                        <i class="fas fa-eye stat-toggle-icon"></i>
                    </div>
                </div>
            </div>

            <div class="search-bar">
                <i class="fas fa-calendar"></i>
                <input type="date" id="date-picker">
                <button class="refresh-btn" onclick="refreshReservations()" title="Refresh reservations">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <div class="main-layout">
                <!-- Pending Reservations Section -->
                <div class="reservations-section">
                    <div class="section-header">
                        <h2><i class="fas fa-hourglass-half"></i> Pending Reservations</h2>
                        <span class="badge-count" id="pending-badge">0</span>
                    </div>
                    <div id="pending-reservations-container" class="cards-grid">
                        <!-- Pending reservations will be displayed as cards here -->
                    </div>
                </div>

                <!-- Completed Reservations Section (Hidden by default) -->
                <div class="reservations-section" id="completed-reservations-section" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-check-circle"></i> Done Reservations</h2>
                        <span class="badge-count completed-badge" id="completed-badge">0</span>
                    </div>
                    <div id="completed-reservations-container" class="cards-grid">
                        <!-- Completed reservations will be displayed as cards here -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Fixed Navigation Popup -->
    <div class="nav-popup-overlay" id="navOverlay"></div>
    <div class="nav-popup" id="navPopup">
        <button class="nav-popup-close" onclick="closeNavPopup()">
            <i class="fas fa-times"></i>
        </button>
        <h3>Test Pages</h3>
        <nav class="nav-popup-list">
            <a href="login.html" class="nav-popup-link">
                <i class="fas fa-sign-in-alt"></i> Login
            </a>
            <a href="register.html" class="nav-popup-link">
                <i class="fas fa-user-plus"></i> Register
            </a>
            <a href="order.html" class="nav-popup-link">
                <i class="fas fa-receipt"></i> Orders
            </a>
            <a href="reservation.html" class="nav-popup-link active">
                <i class="fas fa-calendar-alt"></i> Reservations
            </a>
            <a href="restaurant_bill.html" class="nav-popup-link">
                <i class="fas fa-file-invoice"></i> Bill
            </a>
            <a href="restaurant_reception.html" class="nav-popup-link">
                <i class="fas fa-door-open"></i> Reception
            </a>
        </nav>
    </div>

    <!-- Note Editor Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-sticky-note"></i> Edit Reservation Note</h2>
                <button class="modal-close-btn" onclick="closeNoteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="modal-textarea" id="noteInput"
                    placeholder="Add notes for this reservation..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeNoteModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="modal-btn modal-btn-primary" onclick="saveNote()">
                    <i class="fas fa-save"></i> Save Note
                </button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-print"></i> Reservation Details</h2>
                <button class="modal-close-btn" onclick="closePrintModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-print-content" id="printContent"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closePrintModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="modal-btn modal-btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <button class="nav-popup-btn" onclick="toggleNavPopup()">
        <i class="fas fa-bars"></i>
    </button>

    <script>
        // Reservations Management Functions
        const totalReservationsSpan = document.getElementById('total-reservations');
        const pendingReservationsSpan = document.getElementById('pending-reservations');
        const completedReservationsCountSpan = document.getElementById('completed-reservations-count');
        const pendingReservationsContainer = document.getElementById('pending-reservations-container');
        const completedReservationsContainer = document.getElementById('completed-reservations-container');
        const pendingBadge = document.getElementById('pending-badge');
        const completedBadge = document.getElementById('completed-badge');
        const completedReservationsSection = document.getElementById('completed-reservations-section');
        const completedStatCard = document.querySelector('.completed-stat');

        let reservations = [
            { id: '#R001', guest: 'John Doe', guests: 2, time: '7:00 PM', date: '2025-11-14', table: '5', status: 'Pending', note: '' },
            { id: '#R002', guest: 'Jane Smith', guests: 4, time: '8:00 PM', date: '2025-11-14', table: '12', status: 'Pending', note: '' },
            { id: '#R003', guest: 'Alice Wonderland', guests: 1, time: '6:00 PM', date: '2025-11-14', table: '2', status: 'Pending', note: '' },
            { id: '#R004', guest: 'Bob Johnson', guests: 3, time: '7:30 PM', date: '2025-11-14', table: '8', status: 'Pending', note: '' },
            { id: '#R005', guest: 'Emily Chen', guests: 2, time: '8:30 PM', date: '2025-11-14', table: '10', status: 'Pending', note: '' },
            { id: '#R006', guest: 'Michael Brown', guests: 5, time: '6:30 PM', date: '2025-11-14', table: '15', status: 'Pending', note: '' },
            { id: '#R007', guest: 'Sarah Davis', guests: 2, time: '9:00 PM', date: '2025-11-14', table: '7', status: 'Pending', note: '' },
            { id: '#R008', guest: 'David Wilson', guests: 6, time: '7:15 PM', date: '2025-11-14', table: '1,2', status: 'Pending', note: '' },
        ];
        let completedReservations = [];
        let filteredReservations = [...reservations];

        // Refresh function
        function refreshReservations() {
            filterByDate();
        }

        function updateReservationCounts() {
            const pendingCount = reservations.filter(r => r.status === 'Pending').length;
            const completedCount = completedReservations.length;
            const total = pendingCount + completedCount;

            totalReservationsSpan.textContent = total;
            pendingReservationsSpan.textContent = pendingCount;
            completedReservationsCountSpan.textContent = completedCount;
            pendingBadge.textContent = pendingCount;
            completedBadge.textContent = completedCount;
        }

        function renderReservations(reservationsToRender = null) {
            const displayReservations = reservationsToRender || reservations;
            pendingReservationsContainer.innerHTML = '';

            displayReservations.filter(r => r.status === 'Pending').forEach((reservation, index) => {
                const originalIndex = reservations.findIndex(r => r.id === reservation.id);
                const card = document.createElement('div');
                card.classList.add('order-card');
                card.setAttribute('data-index', originalIndex);
                card.innerHTML = `
                    <div class="card-header">
                        <span class="order-id">${reservation.id}</span>
                        <span class="order-time"><i class="fas fa-clock"></i> ${reservation.time}</span>
                    </div>
                    <div class="card-body">
                        <h3 class="customer-name">${reservation.guest}</h3>
                        <p class="order-items">${reservation.guests} ${reservation.guests === 1 ? 'guest' : 'guests'} • Table ${reservation.table}</p>
                        <div class="card-note-section">
                            <label>Note:</label>
                            <div class="note-display" data-index="${originalIndex}">${reservation.note || 'No notes'}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn print-btn" onclick="printReservation(${originalIndex})" title="Print reservation">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="action-btn done-btn" onclick="completeReservation(${originalIndex})" title="Check in">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteReservation(${originalIndex})" title="Delete reservation">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn note-btn" onclick="editNote(${originalIndex})" title="Add/Edit note">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                    </div>
                `;
                pendingReservationsContainer.appendChild(card);
            });

            // If no pending reservations, show empty state
            if (displayReservations.filter(r => r.status === 'Pending').length === 0) {
                pendingReservationsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i> <p>No pending reservations</p></div>';
            }
        }

        function renderCompletedReservations(reservationsToRender = null) {
            const displayReservations = reservationsToRender || completedReservations;
            completedReservationsContainer.innerHTML = '';

            displayReservations.filter(r => r.status === 'Done').forEach((reservation, index) => {
                const card = document.createElement('div');
                card.classList.add('order-card', 'completed');
                card.innerHTML = `
                    <div class="card-header">
                        <span class="order-id">${reservation.id}</span>
                        <span class="status-badge"><i class="fas fa-check-circle"></i> Done</span>
                    </div>
                    <div class="card-body">
                        <h3 class="customer-name">${reservation.guest}</h3>
                        <p class="order-items">${reservation.guests} ${reservation.guests === 1 ? 'guest' : 'guests'} • Table ${reservation.table}</p>
                        <div class="card-note-section">
                            <label>Note:</label>
                            <div class="note-display">${reservation.note || 'No notes'}</div>
                        </div>
                    </div>
                `;
                completedReservationsContainer.appendChild(card);
            });

            // If no completed reservations, show empty state
            if (displayReservations.filter(r => r.status === 'Done').length === 0) {
                completedReservationsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i> <p>No done reservations</p></div>';
            }
        }

        function completeReservation(index) {
            const reservation = reservations[index];
            reservation.status = 'Done';
            completedReservations.push({ ...reservation });
            reservations.splice(index, 1);
            filteredReservations = [...reservations];
            localStorage.setItem('completedReservations', JSON.stringify(completedReservations));
            updateReservationCounts();
            renderReservations(filteredReservations);
            renderCompletedReservations();
        }

        function deleteReservation(index) {
            if (confirm('Are you sure you want to delete this reservation?')) {
                reservations.splice(index, 1);
                filteredReservations = [...reservations];
                updateReservationCounts();
                renderReservations(filteredReservations);
            }
        }

        function printReservation(index) {
            const reservation = reservations[index];
            const printContent = `
                <p><strong>Reservation ID:</strong> ${reservation.id}</p>
                <p><strong>Guest:</strong> ${reservation.guest}</p>
                <p><strong>Guests:</strong> ${reservation.guests}</p>
                <p><strong>Time:</strong> ${reservation.time}</p>
                <p><strong>Date:</strong> ${reservation.date}</p>
                <p><strong>Table:</strong> ${reservation.table}</p>
                <p><strong>Note:</strong> ${reservation.note || 'No notes'}</p>
            `;
            document.getElementById('printContent').innerHTML = printContent;
            document.getElementById('printModal').classList.add('active');
        }

        function closePrintModal() {
            document.getElementById('printModal').classList.remove('active');
        }

        let currentNoteIndex = null;

        function editNote(index) {
            currentNoteIndex = index;
            document.getElementById('noteInput').value = reservations[index].note || '';
            document.getElementById('noteModal').classList.add('active');
            document.getElementById('noteInput').focus();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            currentNoteIndex = null;
        }

        function saveNote() {
            if (currentNoteIndex !== null) {
                reservations[currentNoteIndex].note = document.getElementById('noteInput').value;
                renderReservations(filteredReservations);
                closeNoteModal();
            }
        }

        // Modal keyboard handlers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeNoteModal();
                closePrintModal();
            }
        });

        // Date filtering function
        function filterByDate() {
            const datePickerValue = document.getElementById('date-picker').value;

            if (!datePickerValue) {
                // If no date selected, show all reservations
                filteredReservations = [...reservations];
            } else {
                // Filter reservations by selected date
                filteredReservations = reservations.filter(reservation => reservation.date === datePickerValue);
            }

            updateReservationCounts();
            renderReservations(filteredReservations);
        }

        // Add event listener for date picker
        document.getElementById('date-picker').addEventListener('change', filterByDate);

        // Toggle completed reservations section when clicking the completed stat card
        const mainLayout = document.querySelector('.main-layout');
        const cardsGrids = document.querySelectorAll('.cards-grid');

        // Function to update layout based on window size and visibility state
        function updateLayout() {
            const isCompleted = completedReservationsSection.style.display !== 'none';
            const windowWidth = window.innerWidth;
            const cardsGrids = document.querySelectorAll('.cards-grid'); // Move here for dynamic selection


            if (isCompleted) {
                // Showing both Pending and Completed
                if (windowWidth < 768) {
                    // Mobile: stack vertically, 1 card per row
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        grid.style.setProperty('grid-template-columns', '1fr', 'important');
                    });
                } else if (windowWidth < 1400) {
                    // Tablet: 2 columns, 1 card per row each
                    mainLayout.style.gridTemplateColumns = '1fr 1fr';
                    cardsGrids.forEach((grid, idx) => {
                        grid.style.setProperty('grid-template-columns', '1fr', 'important');
                    });
                } else {
                    // Desktop: 2 columns, 2 cards per row each
                    mainLayout.style.gridTemplateColumns = '1fr 1fr';
                    cardsGrids.forEach((grid, idx) => {
                        grid.style.setProperty('grid-template-columns', 'repeat(2, 1fr)', 'important');
                    });
                }
            } else {
                // Showing only Pending
                if (windowWidth < 480) {
                    // Mobile: 1 card per row
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        grid.style.setProperty('grid-template-columns', '1fr', 'important');
                    });
                } else if (windowWidth < 768) {
                    // Tablet: 2 cards per row
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        grid.style.setProperty('grid-template-columns', 'repeat(2, 1fr)', 'important');
                    });
                } else if (windowWidth < 1400) {
                    // Tablet+: 3 cards per row
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        grid.style.setProperty('grid-template-columns', 'repeat(3, 1fr)', 'important');
                    });
                } else {
                    // Desktop: 4 cards per row
                    mainLayout.style.gridTemplateColumns = '1fr';
                    cardsGrids.forEach((grid, idx) => {
                        grid.style.setProperty('grid-template-columns', 'repeat(4, 1fr)', 'important');
                    });
                }
            }
        }

        // Initial layout
        updateLayout();

        // Toggle on completed stat card click
        completedStatCard.addEventListener('click', () => {
            const isHidden = completedReservationsSection.style.display === 'none';
            completedReservationsSection.style.display = isHidden ? 'block' : 'none';
            completedStatCard.classList.toggle('active');
            const icon = completedStatCard.querySelector('.stat-toggle-icon');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
            updateLayout();
        });

        // Update layout on window resize
        window.addEventListener('resize', updateLayout);

        // Load completed reservations from localStorage
        const storedCompletedReservations = localStorage.getItem('completedReservations');
        if (storedCompletedReservations) {
            completedReservations = JSON.parse(storedCompletedReservations);
        }

        // Set date picker to today by default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-picker').value = today;
        filterByDate();

        // Initial render
        updateReservationCounts();
        renderReservations();
        renderCompletedReservations();
    </script>
</body>

</html>
